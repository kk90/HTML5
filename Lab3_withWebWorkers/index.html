<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Lab 3</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
</head>
<body>
	<div style="margin-top:20px;margin-left:20px">
		<div class="row">
	  		<div class="col-md-6" style="min-height: 400px;min-width: 610px;">
	  				<canvas width="600" height="400" id="canvasElementId" style="border-style: solid;border-width: 5px;">
						Your browser does not support canvas element
					</canvas>
					<p></p>
					<input type="checkbox" id="filtrSolorizeId"> Solarize
	  				<input type="checkbox" id="filtrNegativeId"> Nagative
	  				<div id="sliderDivId" style="display:none">
	  					<p></p>
	  					<input id="sliderId" type="range" min="0" max="255" step="1" />
	  				</div>
	  		</div>

	  		<div class="col-md-6">
	  			<p>Files:</p>
	  			<ul id="filesListId">
				</ul>
	  		</div>
		</div>
	<div>
	
	<script src="database.js"></script>
	<script>
	(function() {
		"use strict"

		function onStart() {
  			database.open();
  			database.addListId('filesListId');
		}

		var droppedTxtFiles = 0;
		var droppedImageFiles = 0;
		
		var textFromTxtFile = "";
		var imageOriginalState;

		var canvasExtra;
		var contextExtra;

		var filtrNegative = document.getElementById('filtrNegativeId');
	    var filtrSolarize = document.getElementById('filtrSolorizeId');
	    var solarizeSlider = document.getElementById('sliderId');
	    var solarizeSliderDiv = document.getElementById('sliderDivId');

		var canvas = document.getElementById('canvasElementId');
		var context = canvas.getContext('2d');

		window.addEventListener("DOMContentLoaded", onStart, false);

        canvas.addEventListener("dragenter", onDragEnter, false);
        canvas.addEventListener("dragover", onDragOver, false);
        canvas.addEventListener("drop", onDropFiles, false);

	    filtrNegative.addEventListener("click", addFilters, false);
	    filtrSolarize.addEventListener("click", addFilters, false);
		solarizeSlider.addEventListener("change", addFilters, false);
		var negativeAndSolarize = false;
		// workers
		// 
		var workerSolarize = new Worker("solarizeWorker.js");
		var workerNegative = new Worker("negativeWorker.js");

  		workerSolarize.onmessage = function(e) {
			context.putImageData(e.data, 0, 0);

			if(negativeAndSolarize){
				var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
				workerNegative.postMessage({ imageData: imageData });
				negativeAndSolarize = false;
			} else {
				redisplayText();
			}
        };

  		workerNegative.onmessage = function(e) {
			context.putImageData(e.data, 0, 0);
			redisplayText();
        };

  		function makeSolarize(level) {
    	
		   	var imageData = contextExtra.getImageData(0, 0, canvas.width, canvas.height);

		   	workerSolarize.postMessage({ imageData: imageData, level: level});
		}

		function makeNegative() {

	    	var imageData = contextExtra.getImageData(0, 0, canvas.width, canvas.height);

			workerNegative.postMessage({ imageData: imageData });
		}

		function makeNegativeAndSolarize(level) {
			negativeAndSolarize = true;
			var imageData = contextExtra.getImageData(0, 0, canvas.width, canvas.height);
			workerSolarize.postMessage({ imageData: imageData, level: level});
		}

		function restoreOriginaImage() {
	    	if (typeof imageOriginalState != "undefined") {
	    		 canvasExtra = new Canvas();
	    		 canvasExtra.height = canvas.height;
	    		 canvasExtra.width = canvas.width;
				 contextExtra = canvasExtra.getContext('2d');
			     contextExtra.putImageData(imageOriginalState, 0, 0);
	    	}
		}

		function clearImage() {
        	context.clearRect(0, 0, canvas.width, canvas.height);
        }

		function onDropFiles(e) {
            e.stopPropagation();
            e.preventDefault();

            var files = e.dataTransfer.files;

            for (var i = 0; i < files.length; i++) {
                processDroppedFile(files[i]);
            }
        };

        function onDragEnter(e) {
            e.stopPropagation();
            e.preventDefault();
        };

        function onDragOver(e) {
            e.stopPropagation();
            e.preventDefault();
        };

        function processDroppedFile(file) {

        	var imageReader = new FileReader();
            var textReader = new FileReader();

            imageReader.onload = function (e) {

                var image = new Image();

                image.onload = function () {
                	clearImage();
                    context.drawImage(image, 0, 0, canvas.width, canvas.height);
                    imageOriginalState = context.getImageData(0, 0, canvas.width, canvas.height);
                    filtrNegative.checked = false;
	    			filtrSolarize.checked = false;
                    redisplayText();
                };

                image.src = e.target.result;
            };
 			
 			textReader.onload = function (e) {

                var text = e.target.result;
               	
                if(droppedTxtFiles == 1) {
                	imageOriginalState = context.getImageData(0, 0, canvas.width, canvas.height);
                } else {
                	clearImage();
	    			context.putImageData(imageOriginalState, 0, 0);
                	filtrNegative.checked = false;
	    			filtrSolarize.checked = false;
                }

               	displayText(text);
            }; 

			if (file.type.match('image/jpeg') || file.type.match('image/png') || file.type.match('image/jpg')) {
			   droppedImageFiles += 1;
			   imageReader.readAsDataURL(file);
			   addFileToDatabase(file.name);
			} else if (file.type.match('text/plain')) {
				droppedTxtFiles += 1;
                textReader.readAsText(file);
               	addFileToDatabase(file.name);
            } else {
            	alert("File type is not allowed!");
            }  
        };

        function displayText(text) {
        	textFromTxtFile = text;
            context.font = "14px Georgia";
			context.fillText(text, 10, 50);
        }

        function redisplayText() {
            context.font = "14px Georgia";
			context.fillText(textFromTxtFile, 10, 50);
        }

        function addFileToDatabase(name) {
			var date =  (new Date()).toString().split(' ').splice(1,4).join(' ');
			var type = name.split('.').pop();
			database.addFile({ name: name, date: date, type: type});
        }

	    function addFilters() {
	    	restoreOriginaImage();
	    	if(filtrSolarize.checked && filtrNegative.checked) {
	    		var sliderValue = getSliderValue();
	      		displaySlider();
	    		makeNegativeAndSolarize(sliderValue);
	    	}
	    	if(!filtrSolarize.checked && filtrNegative.checked) {
	    		hideSlider();
	    		makeNegative();
	    	}
	    	if(filtrSolarize.checked && !filtrNegative.checked) {
	    		var sliderValue = getSliderValue();
	      		displaySlider();
	    		makeSolarize(sliderValue);
	    	}
	    	if(!filtrSolarize.checked && !filtrNegative.checked) {
	    		hideSlider();
	    		setOriginal();
	    	}
	    	
	    }

	    function setOriginal() {
	    	if (typeof imageOriginalState != "undefined") {
			     context.putImageData(imageOriginalState, 0, 0);
	    	}
	    }

	    function displaySlider() {
	    	solarizeSliderDiv.style.display = "block";
	    }

	    function hideSlider() {
	    	solarizeSliderDiv.style.display = "none";
	    }

	    function getSliderValue() {
	    	return parseInt(solarizeSlider.value);
	    }
	}())
	</script>
</body>
</html>