<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Lab 3</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
</head>
<body>
	<div style="margin-top:20px;margin-left:20px">
		<div class="row">
	  		<div class="col-md-6" style="min-height: 400px;min-width: 610px;">
	  				<canvas width="600" height="400" id="canvasElementId" style="border-style: solid;border-width: 5px;">
						Your browser does not support canvas element
					</canvas>
					<p></p>
					<input type="checkbox" id="filtrSolorizeId"> Solarize
	  				<input type="checkbox" id="filtrNegativeId"> Nagative
	  				<div id="sliderDivId" style="display:none">
	  					<p></p>
	  					<input id="sliderId" type="range" min="0" max="255" step="1" />
	  				</div>
	  		</div>

	  		<div class="col-md-6">
	  			<p>Files:</p>
	  			<ul id="filesListId">
				</ul>
	  		</div>
		</div>
	<div>

	<script>
	(function() {
		"use strict"

		var database = {};

		database.indexedDB = {};


		database.indexedDB = (function() {

			return {

				open: function() {
					
				},
				addFile: function() {
					
				}
			};
		}())
		// OPEN DATABASE
		database.indexedDB.open = function() {

			var version = 1;
			var request = indexedDB.open("files", version);

			request.onupgradeneeded = function(e) {
				var db = e.target.result;

				e.target.transaction.onerror = database.indexedDB.onerror;

				if(db.objectStoreNames.contains("files")) {
			  		db.deleteObjectStore("files");
				}

				var store = db.createObjectStore("files", { keyPath: "id", autoIncrement: true });
			};

			request.onsuccess = function(e) {
				database.indexedDB.db = e.target.result;
				database.indexedDB.getAllFiles();
			};

			request.onerror = database.indexedDB.onerror;
		}

		// ADD FILE
		database.indexedDB.addFile = function(file) {

			var db = database.indexedDB.db;

			var trans = db.transaction(["files"], "readwrite");

			var store = trans.objectStore("files");

			var request = store.put({
				"filename": file.name,
				"filedate": file.date,
				"filetype":  file.type,
			});

			trans.oncomplete = function(e) {
				database.indexedDB.getAllFiles();
			};

			request.onerror = function(e) {
				console.log(e.value);
			};
		};

		// GET ALL
		database.indexedDB.getAllFiles = function() {

			var filesHistory = document.getElementById("filesListId");

			filesHistory.innerHTML = "";

			var db = database.indexedDB.db;

			var trans = db.transaction(["files"], "readwrite");

			var store = trans.objectStore("files");

			var keyRange = IDBKeyRange.lowerBound(0);

			var cursorRequest = store.openCursor(keyRange);

			cursorRequest.onsuccess = function(e) {
				var result = e.target.result;

				if(!!result == false)
			  		return;

				renderFiles(result.value);
				result.continue();
			};

			cursorRequest.onerror = database.indexedDB.onerror;
		};

		// DELETE FILE
		database.indexedDB.deleteFile = function(id) {

			var db = database.indexedDB.db;

			var trans = db.transaction(["files"], "readwrite");

			var store = trans.objectStore("files");

			var request = store.delete(id);

			trans.oncomplete = function(e) {
				database.indexedDB.getAllFiles(); 
			};

			request.onerror = function(e) {
				console.log(e);
			};
		};

		// DISPLAY ALL FILES
		function renderFiles(row) {

			var filesHistory = document.getElementById("filesListId");

			var li = document.createElement("li");

			var a = document.createElement("a");

			var t = document.createTextNode("File: " + row.filename + ", Date: " + row.filedate + ", Type: " + row.filetype);

			a.addEventListener("click", function(e) {
				database.indexedDB.deleteFile(row.id);
			});

			a.textContent = "[Delete File]";
			a.style.cursor = "pointer";

			li.appendChild(t);

			li.appendChild(a);

			filesHistory.appendChild(li);
		}

		function init() {
  			database.indexedDB.open();
		}

		window.addEventListener("DOMContentLoaded", init, false);

		var droppedTxtFiles = 0;
		var droppedImageFiles = 0;
		
		var textFromTxtFile = "";
		var imageOriginalState;

		var filtrNegative = document.getElementById('filtrNegativeId');
	    var filtrSolarize = document.getElementById('filtrSolorizeId');
	    var solarizeSlider = document.getElementById('sliderId');
	    var solarizeSliderDiv = document.getElementById('sliderDivId');

		var canvas = document.getElementById('canvasElementId');
		var context = canvas.getContext('2d');

        canvas.addEventListener("dragenter", onDragEnter, false);
        canvas.addEventListener("dragover", onDragOver, false);
        canvas.addEventListener("drop", onDropFiles, false);

	    filtrNegative.addEventListener("click", addFilters, false);
	    filtrSolarize.addEventListener("click", addFilters, false);
		solarizeSlider.addEventListener("change", addFilters, false);

  		function makeSolarize(level) {
    	
		   	var imageData = context.getImageData(0, 0, canvas.width, canvas.height);

    		var data = imageData.data;

		    for (var i = 0; i <= data.length - 4; i += 4) {
		        data[i] + level <= 255 ? data[i] = data[i] + level : data[i] = 255;
		        data[i + 1] + level <= 255 ? data[i + 1] = data[i + 1] + level : data[i + 1] = 255;
		        data[i + 2] + level <= 255 ? data[i + 2] = data[i + 2] + level : data[i + 2] = 255;
			}

    		context.putImageData(imageData, 0, 0);
		}

		function makeNegative() {

	    	var imageData = context.getImageData(0, 0, canvas.width, canvas.height);

	    	var data = imageData.data;

	    	for (var i = 0; i <= data.length - 4; i += 4) {
	        		data[i] = 255 - data[i]
	        		data[i + 1] = 255 - data[i + 1];
	        		data[i + 2] = 255 - data[i + 2];
	   		}

	    	context.putImageData(imageData, 0, 0);
		}

		function restoreImage() {
	    	if (typeof imageOriginalState != "undefined") {
			    context.putImageData(imageOriginalState, 0, 0);
	    	}
		}

		function clearImage() {
        	context.clearRect(0, 0, canvas.width, canvas.height);
        }

		function onDropFiles(e) {
            e.stopPropagation();
            e.preventDefault();

            var files = e.dataTransfer.files;

            for (var i = 0; i < files.length; i++) {
                processDroppedFile(files[i]);
            }
        };

        function onDragEnter(e) {
            e.stopPropagation();
            e.preventDefault();
        };

        function onDragOver(e) {
            e.stopPropagation();
            e.preventDefault();
        };

        function processDroppedFile(file) {

        	var imageReader = new FileReader();
            var textReader = new FileReader();

            imageReader.onload = function (e) {

                var image = new Image();

                image.onload = function () {
                	clearImage();
                    context.drawImage(image, 0, 0, canvas.width, canvas.height);
                    imageOriginalState = context.getImageData(0, 0, canvas.width, canvas.height);
                    filtrNegative.checked = false;
	    			filtrSolarize.checked = false;
                    redisplayText();
                };

                image.src = e.target.result;
            };
 			
 			textReader.onload = function (e) {

                var text = e.target.result;
               	
                if(droppedTxtFiles == 1) {
                	imageOriginalState = context.getImageData(0, 0, canvas.width, canvas.height);
                } else {
                	clearImage();
	    			context.putImageData(imageOriginalState, 0, 0);
                	filtrNegative.checked = false;
	    			filtrSolarize.checked = false;
                }

               	displayText(text);
            }; 

			if (file.type.match('image/jpeg') || file.type.match('image/png')) {
			   droppedImageFiles += 1;
			   imageReader.readAsDataURL(file);
			   addFileToDatabase(file.name);
			}

			if (file.type.match('text/plain')) {
				droppedTxtFiles += 1;
                textReader.readAsText(file);
               	addFileToDatabase(file.name);
            };     
        };

        function displayText(text) {
        	textFromTxtFile = text;
            context.font = "14px Georgia";
			context.fillText(text, 10, 50);
        }

        function redisplayText() {
            context.font = "14px Georgia";
			context.fillText(textFromTxtFile, 10, 50);
        }

        function addFileToDatabase(name) {
			var date =  (new Date()).toString().split(' ').splice(1,4).join(' ');
			var type = name.split('.').pop();
			database.indexedDB.addFile({ name: name, date: date, type: type});
        }

	    function addFilters() {
	    	clearImage();
	    	restoreImage();
	    	if(filtrSolarize.checked && filtrNegative.checked) {
	    		var sliderValue = getSliderValue();
	      		displaySlider();
	    		makeNegative();
	    		makeSolarize(sliderValue);
	    	}
	    	if(!filtrSolarize.checked && filtrNegative.checked) {
	    		hideSlider();
	    		makeNegative();
	    	}
	    	if(filtrSolarize.checked && !filtrNegative.checked) {
	    		var sliderValue = getSliderValue();
	      		displaySlider();
	    		makeSolarize(sliderValue);
	    	}
	    	if(!filtrSolarize.checked && !filtrNegative.checked) {
	    		hideSlider();
	    		restoreImage();
	    	}
	    	redisplayText();
	    }

	    function displaySlider() {
	    	solarizeSliderDiv.style.display = "block";
	    }

	    function hideSlider() {
	    	solarizeSliderDiv.style.display = "none";
	    }

	    function getSliderValue() {
	    	return parseInt(solarizeSlider.value);
	    }
	}())
	</script>
</body>
</html>