<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>GeoLocation</title>
	<script src="GeoCompass.js"></script>
	<script src="GeoMath.js"></script>
	<script src="GeoLocation.js"></script>
	<style type="text/css">

	.compass {
    		display: block;
    		margin-left: auto;
    		margin-right: auto;
    		margin-top: 160px;
    		transform-origin: 50% 50%;
        	-webkit-transform-origin: 50% 50%;
        	-moz-transform-origin: 50% 50%;
	}
	.direction {
    		display: block;
    		margin-left: auto;
    		margin-right: auto;
    		margin-top: 160px;
    		transform-origin: 50% 50%;
        	-webkit-transform-origin: 50% 50%;
        	-moz-transform-origin: 50% 50%;
	}
	</style>
</head>
<body>
	<h3>
		Distance: <span id="distanceId"></span> m <br/>
		North bearing: <span id="northAngleId"></span> ° <br/>
		Location bearing: <span id="locationAngleId"></span> ° <br/>
	</h3>
	
	<h3>Compass:</h3>
	<img id="compassId" class="compass" src="compass.png" />

	<h3>Direction:</h3>
	<img id="directionId" class="direction" src="compass.png" />

	<script>

	(function(){
		var maxRandomMeters = 150;
		var decimal = 2;
		var distanceText = document.getElementById('distanceId');
		var northAngleText = document.getElementById('northAngleId');
		var locationAngleText = document.getElementById('locationAngleId');

		var compassImg = document.getElementById('compassId');
		var directionImg = document.getElementById('directionId');
		var northAngle = 0;
		var locationAngle = null;
		var initRandomLocation = true;
		var randomPosition = {};

		function onLocationError(err) {
			var text = "Error occurred. Error code: " + err.code + ". ";
			switch(err.code) {
				case 0: 
					text = text + "Unknown error";
					break;
				case 1:
					text = text + "Permission denied";
					break;
				case 2:
					text = text + "Position unavailable";
					break;
				case 3:
					text = text + "Timed out";
					break;
			};
			alert(text);
		}
	
		function onLocationChange(position) {

			// if run get random location
			if(initRandomLocation){
				randomPosition = geoMath.GetRandomLocation(position.lat, position.lng, maxRandomMeters);
				initRandomLocation = false;
			}

			var distance = geoMath.countDistance(position.lat, position.lng, randomPosition.lat, randomPosition.lng)
			distanceText.innerHTML = distance;

			var angleBetweenCoordinates = geoMath.countBearing(position.lat, position.lng, randomPosition.lat, randomPosition.lng);
			locationAngle = angleBetweenCoordinates;
			var angle = parseFloat(northAngle) + parseFloat(angleBetweenCoordinates);
			
			if(angle >= 360){
				angle= angle - 360;
			}	

			changeArrowDirection(angle.toFixed(decimal));	
		}

		function onGeoCompassChange(bearing) {
			northAngle = bearing;
			northAngleText.innerHTML = northAngle;
			compassImg.style.Transform = 'rotate(-' + bearing + 'deg)';
			compassImg.style.WebkitTransform = 'rotate(-'+ bearing + 'deg)';
			compassImg.style.MozTransform = 'rotate(-' + bearing + 'deg)'; 

			if(locationAngle != null){
				var angle = parseFloat(bearing) + parseFloat(locationAngle);
				changeArrowDirection(angle);
			}

		}

		function changeArrowDirection(angle) {
			locationAngleText.innerHTML = angle;
			directionImg.style.Transform = 'rotate(' + angle + 'deg)';
			directionImg.style.WebkitTransform = 'rotate('+ angle + 'deg)';
			directionImg.style.MozTransform = 'rotate(-' + angle + 'deg)'; 
		}

		// on compass change
		geoCompass.watchBearing(onGeoCompassChange);

		// watch current location 
		geoLocation.watchLocation(onLocationChange, onLocationError);
	}());

	</script>

</body>
</html>